node ('docker-agent') {
    // Start of the pipeline script
    
    // Stage 1: Checkout Code
    stage('Checkout') {
        checkout([
            $class: 'GitSCM',
            branches: [
                [$class: 'BranchSpec', name: params.BRANCH]
            ],
            userRemoteConfigs: [
                [
                    url: env.REPO_URL,
                    credentialsId: env.CREDENTIALS_ID
                ]
            ]
        ])
    }
    
    // Stage 2: Build Docker Image
    stage('Build') {
        // Steps for the Build stage
        dir('node-application-example') {
            echo "Building Docker image"
            sh "docker build -t ${DOCKER_IMAGE}:latest -t ${DOCKER_IMAGE}:${BUILD_ID} ."
        }
    }
    
    // Stage 3: Run Docker Container
    stage('Run') {
        // Steps for the Run stage
        echo "Stage 2"
    }
    
    // Stage 4: Cleanup
    stage('Cleanup') {
        // Steps for the Cleanup stage
        echo "Stage 3"
    }
    
    // End of the pipeline script
    post {
        success {
            echo "Build finished successfully!"
        }
        failure {
            echo "Build had failed! Check logs."
        }
    }
}